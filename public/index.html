<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMI Calculator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="container-fluid">
        <ul>
            <li><strong>BMI Calculator</strong></li>
        </ul>
        <ul>
            <li><a href="#" class="theme-switcher" data-theme="light">Light</a></li>
            <li><a href="#" class="theme-switcher" data-theme="dark">Dark</a></li>
        </ul>
    </nav>
    <main class="container my-4">
        <h1>BMI Calculator</h1>
        <p class="lead">Enter your details and see results instantly on the right.</p>

        <div class="row">
            <!-- Left column: inputs -->
            <div class="col-md-6">
                <div id="error-message" class="error-message" role="alert" style="display: none;"></div>
                <form id="bmi-form" class="card p-3">
                    <input type="hidden" name="theme" id="theme-input">
                    <div class="mb-3">
                        <label for="weight" class="form-label">Weight (kg)</label>
                        <input type="number" step="any" class="form-control" id="weight" name="weight" placeholder="Weight" required>
                    </div>
                    <div class="mb-3">
                        <label for="height" class="form-label">Height (cm)</label>
                        <input type="number" step="any" class="form-control" id="height" name="height" placeholder="Height" required>
                    </div>

                    <div class="mb-3">
                        <label for="fatness" class="form-label">Fatness Density (%)</label>
                        <input type="number" step="any" class="form-control" id="fatness" name="fatness" placeholder="e.g. 10">
                    </div>
                    <div class="mb-3">
                        <label for="muscle" class="form-label">Muscle Index (%)</label>
                        <input type="number" step="any" class="form-control" id="muscle" name="muscle" placeholder="e.g. 45">
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Calculate BMI</button>
                        <button type="button" id="reset-btn" class="btn btn-outline-secondary">Reset</button>
                    </div>
                </form>
            </div>

            <!-- Right column: output -->
            <div class="col-md-6">
                <div id="result" class="card p-3">
                    <h2>Your Result</h2>
                    <div class="result-container">
                        <p>Your BMI is: <strong id="bmi" class="bmi-value">—</strong></p>
                        <p>Category: <strong id="category" class="bmi-category">—</strong></p>
                        <p>Custom Index: <strong id="customIndex">—</strong> <span id="customCategory"></span></p>
                        <h3>Recommendations:</h3>
                        <ul id="recommendations"></ul>
                        <h4 id="customRecTitle" style="display:none;">Custom Index Recommendations:</h4>
                        <ul id="customRecommendations"></ul>
                    </div>
                </div>
            </div>
        </div>

    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const themeSwitcher = document.querySelectorAll('.theme-switcher');
            const html = document.querySelector('html');
            const themeInput = document.getElementById('theme-input');
            const bmiForm = document.getElementById('bmi-form');
            const errorMessage = document.getElementById('error-message');
            const resultCard = document.getElementById('result');

            function setActiveSwitcher(theme) {
                themeSwitcher.forEach(s => {
                    if (s.getAttribute('data-theme') === theme) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
            }

            function setTheme(theme, persist = true) {
                html.setAttribute('data-theme', theme);
                themeInput.value = theme;
                setActiveSwitcher(theme);
                if (persist) localStorage.setItem('theme', theme);
            }

            // Apply saved theme on load (persisted in localStorage)
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme, false);
            } else {
                setTheme(html.getAttribute('data-theme') || 'light', false);
            }

            themeSwitcher.forEach(switcher => {
                switcher.addEventListener('click', (event) => {
                    event.preventDefault();
                    const theme = event.target.getAttribute('data-theme');
                    setTheme(theme, true);
                });
            });

            const resetBtn = document.getElementById('reset-btn');
            resetBtn.addEventListener('click', () => {
                bmiForm.reset();
                clearResults();
            });

            function clearResults() {
                document.getElementById('bmi').textContent = '—';
                document.getElementById('bmi').className = 'bmi-value';
                document.getElementById('category').textContent = '—';
                document.getElementById('category').className = 'bmi-category';
                document.getElementById('customIndex').textContent = '—';
                document.getElementById('customCategory').textContent = '';
                document.getElementById('recommendations').innerHTML = '';
                document.getElementById('customRecommendations').innerHTML = '';
                document.getElementById('customRecTitle').style.display = 'none';
                errorMessage.style.display = 'none';
            }

            bmiForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const formData = new FormData(bmiForm);
                const data = Object.fromEntries(formData.entries());

                // Basic validation
                const w = Number(data.weight);
                const h = Number(data.height);
                if (isNaN(w) || isNaN(h) || w <= 0 || h <= 0) {
                    errorMessage.textContent = 'Please enter positive numbers for weight and height.';
                    errorMessage.style.display = 'block';
                    return;
                }

                const response = await fetch('/calculate-bmi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    // If server returned a theme, apply and persist it
                    if (result.theme) {
                        setTheme(result.theme, true);
                    }

                    renderResult(result);
                    // store for persistence if page refresh needed
                    localStorage.setItem('bmiResult', JSON.stringify(result));
                } else {
                    errorMessage.textContent = result.error || 'An error occurred';
                    errorMessage.style.display = 'block';
                }
            });

            function renderResult(result) {
                errorMessage.style.display = 'none';
                const bmiEl = document.getElementById('bmi');
                const catEl = document.getElementById('category');
                const customIdxEl = document.getElementById('customIndex');
                const customCatEl = document.getElementById('customCategory');
                const recList = document.getElementById('recommendations');
                const customRecList = document.getElementById('customRecommendations');
                const customRecTitle = document.getElementById('customRecTitle');

                bmiEl.textContent = result.bmi;
                bmiEl.className = 'bmi-value ' + (result.category || '').toLowerCase().replace(' ', '-');
                catEl.textContent = result.category;
                catEl.className = 'bmi-category ' + (result.category || '').toLowerCase().replace(' ', '-');

                // Custom index
                if (result.customIndex !== null && result.customIndex !== undefined) {
                    customIdxEl.textContent = result.customIndex;
                    customCatEl.textContent = result.customCategory ? ` — ${result.customCategory}` : '';

                    customRecTitle.style.display = 'block';
                    customRecList.innerHTML = '';
                    result.customRecommendations.forEach(r => {
                        const li = document.createElement('li');
                        li.textContent = r;
                        customRecList.appendChild(li);
                    });
                } else {
                    customIdxEl.textContent = '—';
                    customCatEl.textContent = '';
                    customRecList.innerHTML = '';
                    customRecTitle.style.display = 'none';
                }

                // Recommendations for BMI category
                recList.innerHTML = '';
                result.recommendations.forEach(r => {
                    const li = document.createElement('li');
                    li.textContent = r;
                    recList.appendChild(li);
                });

                // Apply color-coded border based on category
                resultCard.className = 'card p-3 result-card ' + (result.category || '').toLowerCase().replace(' ', '-');
            }

            // Load persisted result if exists
            const saved = localStorage.getItem('bmiResult');
            if (saved) {
                renderResult(JSON.parse(saved));
            }
        });
    </script>
</body>
</html>
